<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>WMTS CMEMS : From GetCapabilities to Colorbar</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src="dist/jquery-3.6.0.js"></script>
    <script src="dist/dicopal.js"></script>
    <script>
        dicopal.addPalette({
        type: 'sequential',
        name: 'Rainbow',
        colors: ['#6600FF','#004EFF','#00D5FF','#00FFB2','#88FF00','#FFF600','#FFA400','#FF0002'],
        provider: 'CustomPalette'
        }); 
    </script>
</head>

<body>
    <a>WMTS CMEMS : From GetCapabilities to Colorbar</a>
    <br><br>
    <input type="text" id="myInput" value="Variable id (e.g. TEMP)">
    <br><br>
    <button id="myButton" onclick="genCmap()">Gen Cmap</button>
    <br><br>
    <div id="cbar_out" style="width: 120px; height: 264px; position:relative;">
        <div id="cbar" style="width: 37px; height: 264px; left: 0px; position:relative; border: solid; border-width: 1px;"></div>
        <a id="maxval" style="margin-left:45px; top:0px; position:absolute; font-size: small;"></a>
        <a id="minval" style="margin-left:45px; bottom: 0px; position:absolute; font-size: small;"></a>
        <a id="clabel" style="margin-left:85px; top: 20px; height:264px; position:absolute; font-size: small; writing-mode: vertical-rl; text-orientation: mixed;"></a>
    </div>
    <script>
        var resxv = null;
        var resvg = null;
        const url = "https://wmts.marine.copernicus.eu/teroWmts/INSITU_GLO_PHY_TS_OA_NRT_013_002/cmems_obs-ins_glo_phy-temp-sal_nrt_oa_P1M_202411?request=GetCapabilities&service=WMS"

        const genCmap = async () => {
            const input = document.getElementById("myInput").value;
            console.log(url);
            const res = await getData(url);
            const resx = xml2json(res)
            resvg = resx['Capabilities']['Contents']['Layer'];
            var i=0;
            for (i = 0; i < resvg.length+1; i++) {
                if(i==resvg.length){
                    alert("Variable not found, default cmap");
                    i=0;
                    break;
                }
                if(resvg[i]['ows:Metadata']['VariableInformation']['Id'] == input){
                    break;
                }                
            }            
            resxv = resx['Capabilities']['Contents']['Layer'][i]['ows:Metadata']['VariableInformation']
            console.log(resxv);
            buildCbar(resxv['Colormap'].charAt(0).toUpperCase() + resxv['Colormap'].slice(1),
                parseFloat(resxv['MinimumValue']).toFixed(2),
                parseFloat(resxv['MaximumValue']).toFixed(2),
                resxv['Name'],
                resxv['Unit']);
        }

        function getData(ajaxurl) {
            return $.ajax({
                url: ajaxurl,
                type: 'GET',
            });
        };

        function xml2json(srcDOM) {
            let children = [...srcDOM.children];

            // base case for recursion. 
            if (!children.length) {
                return srcDOM.innerHTML
            }

            // initializing object to be returned. 
            let jsonResult = {};

            for (let child of children) {

                // checking is child has siblings of same name. 
                let childIsArray = children.filter(eachChild => eachChild.nodeName === child.nodeName).length > 1;

                // if child is array, save the values as array, else as strings. 
                if (childIsArray) {
                    if (jsonResult[child.nodeName] === undefined) {
                        jsonResult[child.nodeName] = [xml2json(child)];
                    } else {
                        jsonResult[child.nodeName].push(xml2json(child));
                    }
                } else {
                    jsonResult[child.nodeName] = xml2json(child);
                }
            }

            return jsonResult;
        }

        function buildCbar(colorname, minval, maxval, clabel, unit) {

            var colorlist = dicopal.getSequentialColors(colorname, 10)
            const cbar = document.getElementById('cbar');
            console.log(colorlist.reverse().join(','));
            cbar.style.background = 'linear-gradient(0deg,' + colorlist.reverse().join(',') + ')';

            const mina = document.getElementById('minval');
            mina.innerHTML = minval;

            const maxa = document.getElementById('maxval');
            maxa.innerHTML = maxval;
            maxa.style.float = 'right';
            maxa.style.marginRight = '10px';

            const clabela = document.getElementById('clabel');
            console.log(clabel + ' (' + unit + ')');
            clabela.innerHTML = String(clabel + ' (' + unit + ')');

        }

    </script>
</body>

</html>